<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create New Order</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="container mt-4">
    <h2>Create New Order</h2>

    <!-- Customer Name -->
    <div class="mb-3">
        <label for="customerName" class="form-label">Customer Name</label>
        <input type="text" id="customerName" class="form-control" required>
    </div>

    <!-- Add Product Row -->
    <div class="row mb-3">
        <div class="col">
            <label for="productSelect" class="form-label">Product</label>
            <select id="productSelect" class="form-select"></select>
        </div>
        <div class="col">
            <label for="quantity" class="form-label">Quantity</label>
            <input type="number" id="quantity" class="form-control" min="1">
        </div>
        <div class="col">
            <label for="uomSelect" class="form-label">Unit</label>
            <select id="uomSelect" class="form-select"></select>
        </div>
        <div class="col d-flex align-items-end">
            <button id="addProductBtn" class="btn btn-secondary">Add Product</button>
        </div>
    </div>

    <!-- Order Table -->
    <table class="table table-bordered" id="orderTable">
        <thead>
        <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Unit</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>

    <!-- Submit Order -->
    <button id="submitOrderBtn" class="btn btn-primary">Place Order</button>

    <!-- Success / Error Message -->
    <div id="orderResult" class="mt-3"></div>
</div>

<!-- Bootstrap JS Bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- API Functions -->
<script src="../js/api.js"></script>

<script>
$(document).ready(function() {
    let products = [];
    let uoms = [];
    let orderDetails = [];

    // Load products
    getProducts(function(res) {
        products = res;
        const select = $("#productSelect");
        select.empty().append('<option value="">Select a product</option>');
        products.forEach(p => select.append(`<option value="${p.product_id}">${p.product_name}</option>`));
    });

    // Load UOMs
    getUOMs(function(res) {
        uoms = res;
        const select = $("#uomSelect");
        select.empty().append('<option value="">Select unit</option>');
        uoms.forEach(u => select.append(`<option value="${u.uom_id}">${u.uom_name}</option>`));
    });

    // Add product to order
    $("#addProductBtn").click(function() {
        const productId = $("#productSelect").val();
        const quantity = $("#quantity").val();
        const uomId = $("#uomSelect").val();

        if (!productId || !quantity || !uomId) {
            alert("Select product, quantity, and unit!");
            return;
        }

        const product = products.find(p => p.product_id == productId);
        const uom = uoms.find(u => u.uom_id == uomId);

        orderDetails.push({
            product_id: parseInt(productId),
            quantity: parseFloat(quantity),
            uom_id: parseInt(uomId)
        });

        $("#orderTable tbody").append(`
            <tr>
                <td>${product.product_name}</td>
                <td>${quantity}</td>
                <td>${uom.uom_name}</td>
                <td><button class="btn btn-danger btn-sm removeRow">Remove</button></td>
            </tr>
        `);

        // Clear selection
        $("#productSelect").val('');
        $("#quantity").val('');
        $("#uomSelect").val('');
    });

    // Remove product from order
    $("#orderTable").on("click", ".removeRow", function() {
        const rowIndex = $(this).closest('tr').index();
        orderDetails.splice(rowIndex, 1);
        $(this).closest('tr').remove();
    });

    // Submit order
    $("#submitOrderBtn").click(function() {
        const customerName = $("#customerName").val().trim();
        if (!customerName) {
            alert("Enter customer name!");
            return;
        }
        if (orderDetails.length === 0) {
            alert("Add at least one product!");
            return;
        }

        const payload = {
            customer_name: customerName,
            order_details: orderDetails
        };

        insertOrder(payload, function(response) {
            if (response.order_id && response.total_amount) {
                $("#orderResult").html(`<div class="alert alert-success">
                    Order placed successfully! Order ID: ${response.order_id}, Total Amount: ${response.total_amount}
                </div>`);
                orderDetails = [];
                $("#orderTable tbody").empty();
                $("#customerName").val('');
            } else {
                $("#orderResult").html(`<div class="alert alert-danger">Error: ${response.error}</div>`);
            }
        });
    });
});
</script>
</body>
</html>
