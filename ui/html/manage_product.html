<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Products</title>
  <link rel="stylesheet" href="../css/style.css" />
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
</head>
<body>
  <div class="wrapper">
    
    <!-- Page Content -->
    <div id="content" class="p-4">
      <h2>Manage Products</h2>

      <!-- Add Product Form -->
      <form id="productForm" class="mb-4">
        <div class="form-row">
          <div class="form-group col-md-4">
            <label for="product_name">Product Name</label>
            <input type="text" class="form-control" id="product_name" required autocomplete="off" />
          </div>
          <div class="form-group col-md-3">
            <label for="uom_id">UOM</label>
            <select class="form-control" id="uom_id" required></select>
          </div>
          <div class="form-group col-md-3">
            <label for="price_per_unit">Price Per Unit</label>
            <input type="number" step="0.01" class="form-control" id="price_per_unit" required autocomplete="off" />
          </div>
          <div class="form-group col-md-2 align-self-end">
            <button type="submit" class="btn btn-success btn-block">Add</button>
          </div>
        </div>
      </form>

      <!-- Products Table -->
      <table class="table table-bordered">
        <thead class="thead-dark">
          <tr>
            <th>product_id</th>
            <th>product_name</th>
            <th>UOM</th>
            <th>price</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="productTableBody">
          <!-- Data will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Load jQuery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

  <script>
    const API_BASE_URL = "http://127.0.0.1:5000";
    const uomListApiUrl = API_BASE_URL + "/getUOM";
    const productListApiUrl = API_BASE_URL + "/getProducts";
    const productSaveApiUrl = API_BASE_URL + "/insertProduct";
    const productDeleteApiUrl = API_BASE_URL + "/deleteProduct";

    function get_uom() {
      $.get(uomListApiUrl)
        .done(function (uoms) {
          $("#uom_id").empty();
          uoms.forEach((u) => {
            $("#uom_id").append(`<option value="${u.uom_id}">${u.uom_name}</option>`);
          });
        })
        .fail(function () {
          alert("Failed to load UOM list.");
        });
    }

    function get_all_products() {
      $.get(productListApiUrl)
        .done(function (products) {
          let rows = "";
          products.forEach((p) => {
            rows += `
              <tr>
                <td>${p.product_id}</td>
                <td>${p.product_name}</td>
                <td>${p.uom_name}</td>
                <td>${p.price_per_unit}</td>
                <td>
                  <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.product_id})">Delete</button>
                </td>
              </tr>`;
          });
          $("#productTableBody").html(rows);
        })
        .fail(function () {
          alert("Failed to load products.");
        });
    }

    $("#productForm").submit(function (e) {
      e.preventDefault();
      let productData = {
        product_name: $("#product_name").val().trim(),
        uom_id: $("#uom_id").val(),
        price_per_unit: parseFloat($("#price_per_unit").val()),
      };

      $.ajax({
        url: productSaveApiUrl,
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(productData),
      })
        .done(function () {
          alert("Product added successfully.");
          get_all_products();
          $("#productForm")[0].reset();
        })
        .fail(function () {
          alert("Failed to add product.");
        });
    });

    function deleteProduct(id) {
      if (confirm("Are you sure you want to delete this product?")) {
        $.ajax({
          url: productDeleteApiUrl + "/" + id,
          type: "POST",
        })
          .done(function () {
            alert("Product deleted successfully.");
            get_all_products();
          })
          .fail(function () {
            alert("Failed to delete product.");
          });
      }
    }

    $(document).ready(function () {
      get_uom();
      get_all_products();
    });
  </script>
</body>
</html>
